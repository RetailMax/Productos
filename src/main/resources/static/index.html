<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetailMax - Productos</title>
    <link rel="icon" href="retailmax.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .product-card img {
            object-fit: cover;
            height: 200px;
            width: 100%;
        }
        .category-badge {
            font-size: 0.9em;
            margin-bottom: 0.5em;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 shadow-sm">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <img src="retailmax.png" alt="RetailMax" width="80" height="80" class="me-2" style="object-fit:contain;">
          <span class="fw-bold">RetailMax</span>
        </a>
      </div>
    </nav>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">Catálogo de Productos</h1>
            <div>
                <button id="addCategoriaBtn" class="btn btn-success me-2">
                    <i class="bi bi-tags-fill me-1"></i>Agregar categoría
                </button>
                <button id="addProductoBtn" class="btn btn-warning me-2">
                    <i class="bi bi-box-seam me-1"></i>Agregar producto
                </button>
                <button id="batchBtn" class="btn btn-info">
                    <i class="bi bi-upload me-1"></i>Carga batch
                </button>
            </div>
        </div>
        <!-- Sección de categorías -->
        <h2 class="h5 mb-3">Categorías</h2>
        <div id="categoriasRow" class="row g-3 mb-4">
            <!-- Aquí se insertarán las cards de categorías -->
        </div>
        <!-- Modal Agregar Categoría -->
        <div class="modal fade" id="modalCategoria" tabindex="-1" aria-labelledby="modalCategoriaLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalCategoriaLabel">Agregar nueva categoría</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <form id="formCategoria">
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="catName" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="catName" required maxlength="100">
                  </div>
                  <div class="mb-3">
                    <label for="catDesc" class="form-label">Descripción</label>
                    <input type="text" class="form-control" id="catDesc" required maxlength="500">
                  </div>
                  <div class="mb-3">
                    <label for="catImg" class="form-label">URL de imagen (opcional)</label>
                    <input type="url" class="form-control" id="catImg" maxlength="500">
                  </div>
                  <div id="catMsg" class="alert d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-success">Agregar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!-- Modal Agregar Producto -->
        <div class="modal fade" id="modalProducto" tabindex="-1" aria-labelledby="modalProductoLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalProductoLabel">Agregar nuevo producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <form id="formProducto">
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="prodName" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="prodName" required maxlength="100">
                  </div>
                  <div class="mb-3">
                    <label for="prodDesc" class="form-label">Descripción</label>
                    <input type="text" class="form-control" id="prodDesc" required maxlength="500">
                  </div>
                  <div class="mb-3">
                    <label for="prodBrand" class="form-label">Marca</label>
                    <input type="text" class="form-control" id="prodBrand" required maxlength="50">
                  </div>
                  <div class="mb-3">
                    <label for="prodPrice" class="form-label">Precio</label>
                    <input type="number" class="form-control" id="prodPrice" required min="0">
                  </div>
                  <div class="mb-3">
                    <label for="prodCat" class="form-label">Categoría</label>
                    <select class="form-select" id="prodCat" required></select>
                  </div>
                  <div class="mb-3">
                    <label for="prodImg" class="form-label">URL de imagen (opcional)</label>
                    <input type="url" class="form-control" id="prodImg" maxlength="500">
                  </div>
                  <div id="prodMsg" class="alert d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-warning">Agregar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!-- Modal Carga Batch -->
        <div class="modal fade" id="modalBatch" tabindex="-1" aria-labelledby="modalBatchLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalBatchLabel">Carga batch de productos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <form id="formBatch">
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="batchJson" class="form-label">Pega aquí el JSON (array de productos)</label>
                    <textarea class="form-control" id="batchJson" rows="8" required placeholder='[
  { "name": "...", ... },
  ...
]'></textarea>
                  </div>
                  <div id="batchMsg" class="alert d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-info">Cargar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <h2 class="h5 mb-3">Productos</h2>
        <div id="productsRow" class="row g-4">
            <!-- Aquí se insertarán las cards de productos -->
        </div>
        <div id="noProductsMsg" class="alert alert-info mt-4 d-none">No hay productos para mostrar.</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        const DEFAULT_IMAGE = 'https://via.placeholder.com/300x200?text=Sin+Imagen';
        let categorias = {};

        // Cargar categorías para mapear nombre e imagen
        async function fetchCategorias() {
            const res = await fetch(`${API_BASE}/categorias`);
            const data = await res.json();
            categorias = {};
            data.forEach(cat => {
                categorias[cat.categoriaId] = cat;
            });
        }

        // Cargar productos y renderizar cards
        async function fetchProductos() {
            const res = await fetch(`${API_BASE}/productos`);
            const data = await res.json();
            renderProductos(data._embedded ? data._embedded.productoList : data);
        }

        function renderProductos(productos) {
            // Asegura que productos sea siempre un array
            if (!Array.isArray(productos)) {
                if (productos && productos._embedded && Array.isArray(productos._embedded.productoList)) {
                    productos = productos._embedded.productoList;
                } else {
                    productos = [];
                }
            }
            const row = document.getElementById('productsRow');
            const noMsg = document.getElementById('noProductsMsg');
            row.innerHTML = '';
            if (!productos || productos.length === 0) {
                noMsg.classList.remove('d-none');
                return;
            }
            noMsg.classList.add('d-none');
            productos.forEach(prod => {
                // Corregir obtención de categoría
                const cat = prod.categoria ? categorias[prod.categoria.categoriaId] : {};
                const card = document.createElement('div');
                card.className = 'col-12 col-sm-6 col-md-4 col-lg-3';
                // Formatear precio con separador de miles (punto)
                const precioFormateado = prod.basePrice != null ? prod.basePrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") : '0';
                card.innerHTML = `
                    <div class="card product-card h-100 shadow-sm">
                        <img src="${prod.imageUrl || DEFAULT_IMAGE}" class="card-img-top" alt="Imagen producto">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${prod.name}</h5>
                            <p class="card-text mb-1">${prod.description || ''}</p>
                            <span class="badge bg-secondary category-badge">
                                ${cat && cat.imageUrl ? `<img src='${cat.imageUrl}' alt='cat' style='height:1.5em;width:1.5em;object-fit:cover;border-radius:50%;margin-right:0.3em;'>` : ''}
                                ${cat && cat.name ? cat.name : 'Sin categoría'}
                            </span>
                            <div class="mt-auto">
                                <div class="fw-bold">$${precioFormateado}</div>
                                <div class="text-muted small">Marca: ${prod.brand || '-'}</div>
                                <div class="text-${prod.isActive ? 'success' : 'danger'} small">${prod.isActive ? 'Activo' : 'Inactivo'}</div>
                                <div class="d-flex justify-content-end gap-2 mt-2">
                                    <button class="btn btn-sm btn-outline-primary btn-edit-prod" data-id="${prod.productId}" title="Editar"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-sm btn-outline-danger btn-del-prod" data-id="${prod.productId}" title="Eliminar"><i class="bi bi-trash"></i></button>
                                    <button class="btn btn-sm ${prod.isActive ? 'btn-success' : 'btn-outline-secondary'} btn-toggle-prod" data-id="${prod.productId}" title="${prod.isActive ? 'Desactivar' : 'Activar'}">
                                        <i class="bi ${prod.isActive ? 'bi-toggle-on' : 'bi-toggle-off'}"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                row.appendChild(card);
            });
            // Asignar eventos a los botones de editar y eliminar producto después de renderizar las cards
            row.querySelectorAll('.btn-edit-prod').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = btn.getAttribute('data-id');
                    setProdMsg('', '');
                    try {
                        const res = await fetch(`${API_BASE}/productos/${id}`);
                        if (!res.ok) throw new Error('No se pudo obtener el producto');
                        const prod = await res.json();
                        document.getElementById('prodName').value = prod.name;
                        document.getElementById('prodDesc').value = prod.description;
                        document.getElementById('prodBrand').value = prod.brand;
                        document.getElementById('prodPrice').value = prod.basePrice;
                        document.getElementById('prodImg').value = prod.imageUrl || '';
                        await cargarCategoriasDropdown();
                        document.getElementById('prodCat').value = prod.categoria && prod.categoria.categoriaId ? prod.categoria.categoriaId : '';
                        document.getElementById('formProducto').setAttribute('data-edit-id', id);
                        modalProducto.show();
                    } catch (err) {
                        setProdMsg('Error: ' + err.message, 'danger');
                        modalProducto.show();
                    }
                });
            });
            row.querySelectorAll('.btn-del-prod').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = btn.getAttribute('data-id');
                    const result = await Swal.fire({
                        title: '¿Eliminar producto?',
                        text: 'Esta acción no se puede deshacer.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, eliminar',
                        cancelButtonText: 'Cancelar',
                        reverseButtons: true
                    });
                    if (!result.isConfirmed) return;
                    try {
                        const res = await fetch(`${API_BASE}/productos/${id}`, { method: 'DELETE' });
                        if (!res.ok) throw new Error('No se pudo eliminar el producto');
                        await cargarTodo();
                        await Swal.fire('¡Eliminado!', 'El producto fue eliminado correctamente.', 'success');
                    } catch (err) {
                        await Swal.fire('Error', err.message, 'error');
                    }
                });
            });
            row.querySelectorAll('.btn-toggle-prod').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = btn.getAttribute('data-id');
                    try {
                        const res = await fetch(`${API_BASE}/productos/${id}/toggle-active`, { method: 'PUT' });
                        if (!res.ok) throw new Error('No se pudo cambiar el estado');
                        await cargarTodo();
                        await Swal.fire('¡Listo!', 'El estado del producto fue actualizado.', 'success');
                    } catch (err) {
                        await Swal.fire('Error', err.message, 'error');
                    }
                });
            });
        }

        // Renderizar categorías
        function renderCategorias(categoriasList) {
            const row = document.getElementById('categoriasRow');
            row.innerHTML = '';
            if (!categoriasList || categoriasList.length === 0) {
                row.innerHTML = '<div class="col-12"><div class="alert alert-info">No hay categorías para mostrar.</div></div>';
                return;
            }
            categoriasList.forEach(cat => {
                const card = document.createElement('div');
                card.className = 'col-12 col-sm-6 col-md-4 col-lg-3';
                card.innerHTML = `
                    <div class="card h-100 shadow-sm">
                        <img src="${cat.imageUrl || DEFAULT_IMAGE}" class="card-img-top" alt="Imagen categoría" style="object-fit:cover;height:120px;">
                        <div class="card-body">
                            <h5 class="card-title">${cat.name}</h5>
                            <p class="card-text">${cat.description || ''}</p>
                            <div class="text-${cat.isActive ? 'success' : 'danger'} small mb-2">${cat.isActive ? 'Activo' : 'Inactivo'}</div>
                            <div class="d-flex justify-content-end gap-2 mt-2">
                                <button class="btn btn-sm btn-outline-primary btn-edit-cat" data-id="${cat.categoriaId}" title="Editar"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-outline-danger btn-del-cat" data-id="${cat.categoriaId}" title="Eliminar"><i class="bi bi-trash"></i></button>
                                <button class="btn btn-sm ${cat.isActive ? 'btn-success' : 'btn-outline-secondary'} btn-toggle-cat" data-id="${cat.categoriaId}" title="${cat.isActive ? 'Desactivar' : 'Activar'}">
                                    <i class="bi ${cat.isActive ? 'bi-toggle-on' : 'bi-toggle-off'}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                row.appendChild(card);
            });
            // Asignar eventos a los botones de editar y eliminar
            row.querySelectorAll('.btn-edit-cat').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = btn.getAttribute('data-id');
                    setCatMsg('', '');
                    // Consultar la categoría por la API
                    try {
                        const res = await fetch(`${API_BASE}/categorias/${id}`);
                        if (!res.ok) throw new Error('No se pudo obtener la categoría');
                        const cat = await res.json();
                        document.getElementById('catName').value = cat.name;
                        document.getElementById('catDesc').value = cat.description;
                        document.getElementById('catImg').value = cat.imageUrl || '';
                        document.getElementById('formCategoria').setAttribute('data-edit-id', id);
                        modalCategoria.show();
                    } catch (err) {
                        setCatMsg('Error: ' + err.message, 'danger');
                        modalCategoria.show();
                    }
                });
            });
            row.querySelectorAll('.btn-del-cat').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = btn.getAttribute('data-id');
                    const result = await Swal.fire({
                        title: '¿Eliminar categoría?',
                        text: 'Esta acción no se puede deshacer.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, eliminar',
                        cancelButtonText: 'Cancelar',
                        reverseButtons: true
                    });
                    if (!result.isConfirmed) return;
                    try {
                        const res = await fetch(`${API_BASE}/categorias/${id}`, { method: 'DELETE' });
                        if (!res.ok) throw new Error('No se pudo eliminar la categoría');
                        await cargarTodo();
                        await Swal.fire('¡Eliminado!', 'La categoría fue eliminada correctamente.', 'success');
                    } catch (err) {
                        await Swal.fire('Error', err.message, 'error');
                    }
                });
            });
            row.querySelectorAll('.btn-toggle-cat').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = btn.getAttribute('data-id');
                    try {
                        const res = await fetch(`${API_BASE}/categorias/${id}/toggle-active`, { method: 'PUT' });
                        if (!res.ok) throw new Error('No se pudo cambiar el estado');
                        await cargarTodo();
                        await Swal.fire('¡Listo!', 'El estado de la categoría fue actualizado.', 'success');
                    } catch (err) {
                        await Swal.fire('Error', err.message, 'error');
                    }
                });
            });
        }

        async function cargarTodo() {
            await fetchCategorias();
            await fetchProductos();
            renderCategorias(Object.values(categorias));
        }

        document.getElementById('addCategoriaBtn').addEventListener('click', () => {
            document.getElementById('formCategoria').reset();
            setCatMsg('', '');
            document.getElementById('formCategoria').removeAttribute('data-edit-id');
            modalCategoria.show();
        });
        document.getElementById('addProductoBtn').addEventListener('click', () => {
            document.getElementById('formProducto').reset();
            setProdMsg('', '');
            cargarCategoriasDropdown();
            modalProducto.show();
        });
        document.getElementById('batchBtn').addEventListener('click', () => {
            document.getElementById('formBatch').reset();
            setBatchMsg('', '');
            modalBatch.show();
        });

        // Modal y formulario de categoría
        const modalCategoria = new bootstrap.Modal(document.getElementById('modalCategoria'));
        // Modificar el submit del formCategoria para soportar edición
        document.getElementById('formCategoria').addEventListener('submit', async function(e) {
            e.preventDefault();
            setCatMsg('', '');
            const nombre = document.getElementById('catName').value.trim();
            const desc = document.getElementById('catDesc').value.trim();
            const img = document.getElementById('catImg').value.trim();
            const editId = document.getElementById('formCategoria').getAttribute('data-edit-id');
            try {
                let res;
                if (editId) {
                    // Edición
                    res = await fetch(`${API_BASE}/categorias/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: nombre, description: desc, imageUrl: img || null })
                    });
                } else {
                    // Creación
                    res = await fetch(`${API_BASE}/categorias`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: nombre, description: desc, imageUrl: img || null })
                    });
                }
                if (!res.ok) throw new Error(editId ? 'Error al editar categoría' : 'Error al crear categoría');
                await cargarTodo();
                await Swal.fire('¡Éxito!', editId ? 'Categoría editada exitosamente.' : 'Categoría creada exitosamente.', 'success');
                setTimeout(() => { modalCategoria.hide(); }, 1000);
            } catch (err) {
                await Swal.fire('Error', err.message, 'error');
            } finally {
                document.getElementById('formCategoria').removeAttribute('data-edit-id');
            }
        });
        // Al abrir el modal para crear, limpiar el atributo de edición
        document.getElementById('addCategoriaBtn').addEventListener('click', () => {
            document.getElementById('formCategoria').reset();
            setCatMsg('', '');
            document.getElementById('formCategoria').removeAttribute('data-edit-id');
            modalCategoria.show();
        });
        function setCatMsg(msg, type) {
            const el = document.getElementById('catMsg');
            if (!msg) { el.className = 'alert d-none'; el.textContent = ''; return; }
            el.className = 'alert alert-' + type; el.textContent = msg;
        }

        // Modal y formulario de producto
        const modalProducto = new bootstrap.Modal(document.getElementById('modalProducto'));
        function setProdMsg(msg, type) {
            const el = document.getElementById('prodMsg');
            if (!msg) { el.className = 'alert d-none'; el.textContent = ''; return; }
            el.className = 'alert alert-' + type; el.textContent = msg;
        }
        async function cargarCategoriasDropdown() {
            // Solo categorías activas
            const res = await fetch(`${API_BASE}/categorias`);
            const data = await res.json();
            const select = document.getElementById('prodCat');
            select.innerHTML = '';
            (data.filter ? data.filter(c => c.isActive !== false) : data).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.categoriaId;
                opt.textContent = cat.name;
                select.appendChild(opt);
            });
        }
        document.getElementById('formProducto').addEventListener('submit', async function(e) {
            e.preventDefault();
            setProdMsg('', '');
            const nombre = document.getElementById('prodName').value.trim();
            const desc = document.getElementById('prodDesc').value.trim();
            const brand = document.getElementById('prodBrand').value.trim();
            const price = parseInt(document.getElementById('prodPrice').value, 10);
            const catId = document.getElementById('prodCat').value;
            const img = document.getElementById('prodImg').value.trim();
            const editId = document.getElementById('formProducto').getAttribute('data-edit-id');
            try {
                let res;
                if (editId) {
                    // Edición
                    res = await fetch(`${API_BASE}/productos/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: nombre, description: desc, brand: brand, basePrice: price, imageUrl: img || null, categoria: { categoriaId: catId }, productId: editId })
                    });
                } else {
                    // Creación
                    res = await fetch(`${API_BASE}/productos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: nombre, description: desc, brand: brand, basePrice: price, imageUrl: img || null, categoria: { categoriaId: catId } })
                    });
                }
                if (!res.ok) throw new Error(editId ? 'Error al editar producto' : 'Error al crear producto');
                await cargarTodo();
                await Swal.fire('¡Éxito!', editId ? 'Producto editado exitosamente.' : 'Producto creado exitosamente.', 'success');
                setTimeout(() => { modalProducto.hide(); }, 1000);
            } catch (err) {
                await Swal.fire('Error', err.message, 'error');
            } finally {
                document.getElementById('formProducto').removeAttribute('data-edit-id');
            }
        });

        // Modal y formulario de carga batch
        const modalBatch = new bootstrap.Modal(document.getElementById('modalBatch'));
        function setBatchMsg(msg, type) {
            const el = document.getElementById('batchMsg');
            if (!msg) { el.className = 'alert d-none'; el.textContent = ''; return; }
            el.className = 'alert alert-' + type; el.textContent = msg;
        }
        document.getElementById('formBatch').addEventListener('submit', async function(e) {
            e.preventDefault();
            setBatchMsg('', '');
            let datos;
            try {
                datos = JSON.parse(document.getElementById('batchJson').value);
                if (!Array.isArray(datos)) throw new Error('El JSON debe ser un array');
            } catch (err) {
                await Swal.fire('Error', 'JSON inválido: ' + err.message, 'error');
                return;
            }
            try {
                const endpoint = `${API_BASE}/productos/batch`;
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                if (!res.ok) throw new Error('Error al cargar datos batch');
                await cargarTodo();
                await Swal.fire('¡Carga batch exitosa!', 'Los productos fueron cargados correctamente.', 'success');
                setTimeout(() => { modalBatch.hide(); }, 1200);
            } catch (err) {
                await Swal.fire('Error', err.message, 'error');
            }
        });
        window.addEventListener('DOMContentLoaded', cargarTodo);
    </script>
</body>
</html> 